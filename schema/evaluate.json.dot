{
  "id": "http://json-script.com/schema/evaluate.json#",
  "$schema": "http://json-script.com/schema/evaluate_metaschema.json#",
  "title": "JSONScript evaluation schema",
  "description": "Schema with custom keywords that evaluates JSON script. It assumes that the script is valid",
  "switch": [
    {
      "if": { "type": "object" },
      "then": {
        "switch": [
          {{~ it.instructions:inst }}
            {
              "if": { "required": [ "{{=inst.name}}" ] },
              "then": {
                "allOf": [
                  {
                    "title": "evaluate properties",
                    "description": "evaluates all or some keywords using this (full) schema, properties-scripts are replaced with returned synchronous or asynchronous value",
                    {{? inst.evaluate.keywords }}
                      "properties": {
                        {{~ inst.evaluate.keywords:keyword:i }}
                          {{?i}},{{?}}
                          "{{=keyword}}": { "$ref": "#" }
                        {{~}}
                      }
                    {{??}}
                      "additionalProperties": { "$ref": "#" }
                    {{?}}
                  },
                  {
                    "title": "object to [async] value",
                    "description": "Merge object properties into a single [asynchronous] object value",
                    "objectToAsync": true
                  },
                  {
                    "title": "execute instruction",
                    "description": "executes supported script instructions",
                    "validateAsync": {
                      "allOf": [
                        {
                          "description": "valdate evaluated instruction keywords",
                          "properties": {{= JSON.stringify(inst.schema) }}
                        },
                        {
                          "description": "execute instruction using custom keyword",
                          "{{=inst.evaluate.validatorKeyword}}": true
                        }
                      ]
                    }
                  }
                ]
              }
            },
          {{~}}
          {
            "then": {
              "allOf": [
                {
                  "title": "evaluate properties",
                  "description": "evaluates all properties using the same schema, properties-scripts are replaced with returned synchronous or asynchronous value",
                  "additionalProperties": { "$ref": "#" }
                },
                {
                  "title": "object to [async] value",
                  "description": "Merge object properties into a single [asynchronous] object value",
                  "objectToAsync": true
                }
              ]
            }
          }
        ]
      }
    },
    {
      "if": { "type": "array" },
      "then": {
        "title": "sequential execution",
        "description": "queues items so that the next items is executed only after the previous asynchronous value receives data",
        "itemsSerial": { "$ref": "#" }
      }
    }
  ]
}
